#!/usr/bin/env bash

for file in $(git ls-files -- '*_test.go'); do
	if [[ $(sed -n '/^\/\/go:build/p;q' ${file}) ]]; then
		#echo "${file} starts with //go:build"
		continue
	elif [[ $(sed -n '/^\/\/ Code generated by/p;q' ${file}) ]]; then
		#echo "${file} is generated code that should not be touched"
		continue
	else
	    sed '1s/^/\/\/go:build test_all\n\n/' ${file} > "${file}_tmp"
	    rm ${file}
	    mv "${file}_tmp" ${file}
	    echo "Prepended //go:build test_all to ${file}"
	fi
done
